<div class="animated fadeIn">
    <div class="card" id="new">
        <div class="card-header"><i class="icon-pencil"></i> E-LOKET</div>
        <div class="card-block">
            <div class="row">
                <div class="col-md-12">
                    <div class="tab-content">
                        {{!-- table transaksi selesai --}}
                        <div class="row col">
                            <h5>I. TRANSAKSI SELESAI</h5>
                        </div>
                        <div id="navSelesai"><ul class="pagination"></ul></div>
                        <table id="tableSelesai" class="table table-bordered table-striped"
                            width="100%">
                            <thead>
                                <tr>
                                    <th width="1%">No</th>
                                    <th width="10%">Nomor Transaksi</th>
                                    <th width="15%">Tanggal Selesai</th>
                                    <th width="15%">Tanggal Pembayaran</th>
                                    <th width="6%">Nilai Pengajuan</th>
                                    <th width="6%">Pajak</th>
                                    <th width="6%">Nilai Pembayaran</th>
                                    <th width="6%">Metode Pembayaran</th>
                                    <th width="20%">Deskripsi</th>
                                    <th width="10%">Cek Detail</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                                {{#unless daftarSelesai}}
                                    <p class="text-center">Belum terdapat pengajuan yang selesai</p>
                                {{/unless}}
                        {{!-- table pengajuan --}}
                        <div class="row col">
                            <h5>II. PENGAJUAN</h5>
                        </div>
                        <div id="navPengajuan"><ul class="pagination"></ul></div>
                        <table id="tablePengajuan" class="table table-bordered table-striped"
                            width="100%">
                            <thead>
                                <tr>
                                    <th width="1%">No</th>
                                    <th width="4%">Kode Unit</th>
                                    <th width="10%">Nomor Transaksi</th>
                                    <th width="15%">Tanggal Pengajuan</th>
                                    <th width="6%">Nilai Pengajuan</th>
                                    <th width="20%">Deskripsi</th>
                                    <th width="7%">Posisi</th>
                                    <th width="7%">Status</th>
                                    <th width="20%">Catatan</th>
                                    <th width="10%">Cek Akun</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                                {{#unless daftarPengajuan}}
                                    <p class="text-center">Belum terdapat pengajuan</p>
                                {{/unless}}
                        {{!-- realisasi --}}
                        <div class="row col">
                            <h5 class="row col-12">III. REALISASI</h5><br>
                            <h6 class="row col-12">a. Realisasi per unit</h6><br>
                            <h6 class="row col-12">b. Total realisasi</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{{!-- --------------------------- MODAL ------------------------------ --}}

<div class="modal fade" id="modalDetail" role="dialog" data-backdrop="static"
    aria-labelledby="modalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="">Detail tiket</h5>
                <button type="button" class="close" data-dismiss="modal"
                    aria-label="Close"><span
                        aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body row" id="modalDetailTiket">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                    data-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>




{{!-- --------------------------- SCRIPT ------------------------------ --}}

<script id="daftarSelesai" type="text/x-handlebars-template">
    {{#each daftarSelesai}}
        <tr id="{{this._id}}">
            <td style="text-align:center"></td>
            <td style="text-align:center">{{this.nomorTransaksi}}</td>
            <td style="text-align:center">{{this.tanggal.selesai}}</td>
            <td style="text-align:center">{{this.tanggal.transfer}}</td>
            <td class="format-uang">{{this.nilaiPengajuan}}</td>
            <td class="format-uang">{{this.nilaiPajak}}</td>
            <td class="format-uang">{{this.nilaiTransfer}}</td>
            <td style="text-align:center">{{this.metodeTransfer}}</td>
            <td>{{this.detail}}</td>
            <td style="text-align:center">
                <button type="button" class="btn btn-primary mb-1" data-toggle="modal" data-target="#modalDetail" id="btnDetailSelesai">Lihat Detail</button>
                {{!-- <form action="/loket/downloadSpjTiketBank" method="post">
                    <input type="hidden" name="tiketId" value="{{this._id}}">
                    <button type="submit" class="btn btn-success" id="downloadSpjTiket">Download <br>yang disahkan</button>
                </form> --}}
            </td>
        </tr>
    {{/each}}
</script>
<script id="daftarPengajuan" type="text/x-handlebars-template">
    {{#each daftarPengajuan}}  
        <tr id="{{this._id}}">
            <td style="text-align:center"></td>
            <td style="text-align:center">{{this.kodeUnit}}</td>
            <td style="text-align:center">{{this.nomorTransaksi}}</td>
            <td style="text-align:center">{{this.tanggal.pengajuan}}</td>
            <td class="format-uang">{{this.nilaiPengajuan}}</td>
            <td>{{this.detail}}</td>
            <td style="text-align:center">{{this.posisi}}</td>
            <td style="text-align:center">{{this.status}}</td>
            <td>
                {{#if_eq this.status 'Belum selesai'}}
                    {{#if_eq this.posisi 'Verifikator'}}
                    {{else}}
                        {{#if_eq this.posisi 'PPK'}}
                        {{else}}
                            {{#if_eq this.posisi 'PPSPM'}}
                                PPK : {{this.catatan.ppk}}    
                            {{else}}
                                {{#if_eq this.posisi 'Reviewer'}}
                                    PPK : {{this.catatan.ppk}}<br>
                                    PPSPM : {{this.catatan.ppspm}}        
                                {{else}}
                                    PPK : {{this.catatan.ppk}}<br>
                                    PPSPM : {{this.catatan.ppspm}}<br>
                                    Reviewer : {{this.catatan.reviewer}}
                                {{/if_eq}}
                            {{/if_eq}}
                        {{/if_eq}}
                    {{/if_eq}}
                {{else}}                    
                    {{#if_eq this.posisi 'PPK'}}
                        PPK: {{this.catatan.ppk}}    
                    {{else}}
                        {{#if_eq this.posisi 'PPSPM'}}
                        PPK: {{this.catatan.ppk}}<br>
                        PPSPM: {{this.catatan.ppspm}}
                        {{else}}
                            {{#if_eq this.posisi 'Reviewer'}}
                                PPK: {{this.catatan.ppk}}<br>
                                PPSPM: {{this.catatan.ppspm}}<br>
                                Reviewer: {{this.catatan.reviewer}}
                            {{/if_eq}}
                        {{/if_eq}}
                    {{/if_eq}}
                {{/if_eq}}
            </td>
            <td style="text-align:center">
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modalDetail" id="btnDetailPengajuan">Lihat Detail</button>
            </td>
        </tr>
    {{/each}}
</script>

<script type="text/javascript">
    // const socket = io.connect($(location).attr('host'));

    var socket = io();

    //untuk hak akses
    // var user_aktiv = '{{username}}';

    $(document).ready(function () {

        var falseUser = "{{falseUser}}"
        if(falseUser){
            generalAlert('Maaf Anda bukan '+falseUser+'. Silahkan ganti akun Anda.')
            falseUser = ""
        }

        //reset modal
        $(".modal").on("hidden.bs.modal", function() {
            $(".modal-body").html('')
            $(".modal-footer").html('<button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>');
        });

        //iterasi tabel selsai dan pengjuan
        var dPengajuan = $("#daftarPengajuan").html()
        $("#tablePengajuan tbody").html(dPengajuan)
        var dSelesai = $("#daftarSelesai").html()
        $("#tableSelesai tbody").html(dSelesai)

        //iterasi nomor row
        $("#tableSelesai tr").each(function(index){
            $(this).find("td:eq(0)").each(function(){
                $(this).text(index)
                //console.log($(this).text())
            })
        })
        $("#tablePengajuan tr").each(function(index){
            $(this).find("td:eq(0)").each(function(){
                $(this).text(index)
                //console.log($(this).text())
            })
        })

        //pagination
        var rowsShown = 10;
        //pagination selesai
        var rownSelesai = $('#tableSelesai tbody tr').length;
        var pageSelesai = Math.ceil(rownSelesai/rowsShown);
        var last = pageSelesai-1
        $("#navSelesai ul").append(
            '<li class="page-item">'+
                '<a class="page-link" href="#" rel="0">First</a>'+
            '</li>'
        )
        for(i = 0;i < pageSelesai;i++) {
            if (i < 3){
                var pageNum = i + 1;
                $("#navSelesai ul").append('<li class="page-item"><a class="page-link" href="#" rel="'+i+'">'+pageNum+'</a></li>')
            } else {break}
        }
        $("#navSelesai ul").append(
            '<li class="page-item">'+
                '<a class="page-link" href="#" rel="'+last+'">Last</a>'+
            '</li>'
        )
        $('#tableSelesai tbody tr').hide();
        $('#tableSelesai tbody tr').slice(0, rowsShown).show();
        $('#navSelesai a:first').addClass('active');
        $('#navSelesai a').bind('click', function(){
            $('#navSelesai a').removeClass('active');
            $(this).addClass('active');
            var currPage = parseInt($(this).attr('rel'));
            var pages = [currPage-2, currPage-1, currPage, currPage+1, currPage+2, currPage+3]
            var startItem = currPage * rowsShown;
            var endItem = startItem + rowsShown;
            $('#tableSelesai tbody tr').css('opacity','0.0').hide().slice(startItem, endItem).css('display','table-row').animate({opacity:1}, 300)
            if (pages[1]==-1 && pageSelesai>3){
                $("#navSelesai ul li:eq(1) a").attr('rel', pages[2]).text(pages[3])
                $("#navSelesai ul li:eq(2) a").attr('rel', pages[3]).text(pages[4])
                $("#navSelesai ul li:eq(3) a").attr('rel', pages[4]).text(pages[5])
            } else if (pages[3]==pageSelesai && pageSelesai>3) {
                $("#navSelesai ul li:eq(1) a").attr('rel', pages[0]).text(pages[1])
                $("#navSelesai ul li:eq(2) a").attr('rel', pages[1]).text(pages[2])
                $("#navSelesai ul li:eq(3) a").attr('rel', pages[2]).text(pages[3])
            } else if(pageSelesai>3) {
                $("#navSelesai ul li:eq(1) a").attr('rel', pages[1]).text(pages[2])
                $("#navSelesai ul li:eq(2) a").attr('rel', pages[2]).text(pages[3])
                $("#navSelesai ul li:eq(3) a").attr('rel', pages[3]).text(pages[4])
            }
        });
        //pagination pengajuan
        var rownPengajuan = $('#tablePengajuan tbody tr').length;
        var pagePengajuan = Math.ceil(rownPengajuan/rowsShown);
        var last = pagePengajuan-1 //rel
        $("#navPengajuan ul").append(
            '<li class="page-item">'+
                '<a class="page-link" href="#" rel="0">First</a>'+
            '</li>'
        )
        for(i = 0;i < pagePengajuan;i++) {
            if (i < 3) {
                var pageNum = i + 1;
                $("#navPengajuan ul").append('<li class="page-item"><a class="page-link" href="#" rel="'+i+'">'+pageNum+'</a></li>')
            } else {break}
        }
        {{!-- if (pages[1]!=0) {
            $("#navPengajuan ul").append('<li class="page-item"><a class="page-link" href="#" rel="'+pages[0]+'">'+pages[1]+'</a></li>')
        }
        $("#navPengajuan ul").append('<li class="page-item"><a class="page-link" href="#" rel="'+pages[1]+'">'+pages[2]+'</a></li>')
        if(pages[3]<=pagePengajuan){
            $("#navPengajuan ul").append('<li class="page-item"><a class="page-link" href="#" rel="'+pages[2]+'">'+pages[3]+'</a></li>')
        } --}}

        $("#navPengajuan ul").append(
            '<li class="page-item">'+
                '<a class="page-link" href="#" rel="'+last+'">Last</a>'+
            '</li>'
        )
        $('#tablePengajuan tbody tr').hide();
        $('#tablePengajuan tbody tr').slice(0, rowsShown).show();
        $('#navPengajuan a:first').addClass('active');
        $('#navPengajuan a').bind('click', function(){
            $('#navPengajuan a').removeClass('active');
            $(this).addClass('active');
            var currPage = parseInt($(this).attr('rel'));
            var pages = [currPage-2, currPage-1, currPage, currPage+1, currPage+2, currPage+3]
            var startItem = currPage * rowsShown;
            var endItem = startItem + rowsShown;
            $('#tablePengajuan tbody tr').css('opacity','0.0').hide().slice(startItem, endItem).css('display','table-row').animate({opacity:1}, 300)
            if (pages[1]==-1 && pagePengajuan>3){
                $("#navPengajuan ul li:eq(1) a").attr('rel', pages[2]).text(pages[3])
                $("#navPengajuan ul li:eq(2) a").attr('rel', pages[3]).text(pages[4])
                $("#navPengajuan ul li:eq(3) a").attr('rel', pages[4]).text(pages[5])
            } else if (pages[3]==pagePengajuan && pagePengajuan>3) {
                $("#navPengajuan ul li:eq(1) a").attr('rel', pages[0]).text(pages[1])
                $("#navPengajuan ul li:eq(2) a").attr('rel', pages[1]).text(pages[2])
                $("#navPengajuan ul li:eq(3) a").attr('rel', pages[2]).text(pages[3])
            } else if(pagePengajuan>3) {
                $("#navPengajuan ul li:eq(1) a").attr('rel', pages[1]).text(pages[2])
                $("#navPengajuan ul li:eq(2) a").attr('rel', pages[2]).text(pages[3])
                $("#navPengajuan ul li:eq(3) a").attr('rel', pages[3]).text(pages[4])
            }
        });

        //lihat detail row terpilih
        var tableBtnDetail = $("table :button")
        tableBtnDetail.click(function () {
            var id = $(this).closest('tr').attr('id')
            //console.log('idtiket:' + data)
            //console.log('idbutton: ' + this.id)
            socket.emit('mintaDetailTiket', id)
        })

        socket.on('terimaDetailTiket', function (detail) {

            //ambil nilai di checklist
            var check = []
            if (detail.posisi == 'PPK') {
                for (key in detail.checklist) {
                    if (detail.checklist.hasOwnProperty(key)) {
                        var value = detail.checklist[key];
                        if (value[0] == true) {
                            var l = ' '+key
                            check.push(l)
                        }
                    }
                }
            } else if (detail.posisi == 'PPSPM') {
                for (key in detail.checklist) {
                    if (detail.checklist.hasOwnProperty(key)) {
                        var value = detail.checklist[key];
                        if (value[0] == true && value[1] == true) {
                            var l = ' '+key
                            check.push(l)
                        }
                    }
                }
            } else {
                for (key in detail.checklist) {
                    if (detail.checklist.hasOwnProperty(key)) {
                        var value = detail.checklist[key];
                        if (value[0] == true && value[1] == true && value[2] == true) {
                            var l = ' '+key
                            check.push(l)
                        }
                    }
                }
            }

            //ambil nilai di catatan
            var catat = []
            for (key in detail.catatan) {
                if (detail.catatan.hasOwnProperty(key)) {
                    var value = detail.catatan[key];
                    catat.push(value)
                }
            }

            //isi modal-body
            var templatePengajuan =
                '<div class="col-12">' +
                    '<div class="row">' +
                        '<label class="col-2">Unit</label>' +
                        '<p class="col">' + detail.unit + '</p>' +
                    '</div>' +
                    '<div class="row">' +
                        '<label class="col-2">Kode Unit</label>' +
                        '<p class="col">' + detail.kodeUnit + '</p>' +
                    '</div>' +
                    '<div class="row">' +
                        '<label class="col-2">Operator</label>' +
                        '<p class="col">' + detail.operator + '</p>' +
                    '</div>' +
                    '<div class="row">' +
                        '<label class="col-2">Detail POK</label>' +
                        '<div class="col-1">' +
                            '<p>Program</p>' +
                            '<p>Kegiatan</p>' +
                            '<p>Output</p>' +
                            '<p>Komponen</p>' +
                            '<p>Akun</p>' +
                            '<p>Detail Belanja</p>' +
                        '</div>' +
                        '<div class="col">' +
                            '<p>: ' + detail.kdprogram +' '+ detail.uraianProgram + '</p>' +
                            '<p>: ' + detail.kdkegiatan +' '+ detail.uraianKegiatan + '</p>' +
                            '<p>: ' + detail.kdoutput +' '+ detail.uraianOutput + '</p>' +
                            '<p>: ' + detail.kdkomponen +' '+ detail.uraianKomponen + '</p>' +
                            '<p>: ' + detail.kdakun +' '+ detail.uraianAkun + '</p>' +
                            '<p>: ' + detail.uraianDetail + '</p>' +
                        '</div>' +
                    '</div>' +
                    '<div class="row">' +
                        '<label class="col-2">Tanggal Pelaksanaan</label>' +
                        '<p class="col">' + detail.tanggal.pelaksanaan + '</p>' +
                    '</div>' +
                    '<div class="row">' +
                        '<label class="col-2">Detail</label>' +
                        '<p class="col">' + detail.detail + '</p>' +
                    '</div>' +
                    '<div class="row">' +
                        '<label class="col-2">Nilai</label>' +
                        '<p class="col">Rp ' + formatUang(detail.nilaiPengajuan) + '</p>' +
                    '</div>' +
                    '<div class="row">' +
                        '<label class="col-2">Checklist</label>' +
                        '<p class="col">' + check + '</p>' +
                    '</div>' +
                    '<div class="row">' +
                        '<label class="col-2">SPJ</label>' +
                        '<p class="col-3">' + detail.fileSpj + '</p>' +
                        '<form action="/loket/downloadSpjTiket" method="post">' +
                            '<input type="hidden" name="tiketId" value="' + detail._id + '">' +
                            '<button type="submit" class="btn btn-primary" id="downloadSpjTiket">Download SPJ</button>' +
                        '</form>' +
                    '</div>' +
                    '<div class="row">' +
                        '<label class="col-2">SPP</label>' +
                        '<p class="col">' + detail.spp + '</p>' +
                    '</div>' +
                    '<div class="row">' +
                        '<label class="col-2">Catatan PPK</label>' +
                        '<p class="col">' + catat[0] + '</p>' +
                    '</div>' +
                    '<div class="row">' +
                        '<label class="col-2">Catatan PPSPM</label>' +
                        '<p class="col">' + catat[1] + '</p>' +
                    '</div>' +
                    '<div class="row">' +
                        '<label class="col-2">Catatan Reviewer</label>' +
                        '<p class="col">' + catat[2] + '</p>' +
                    '</div>' +
                    '<div class="row">' +
                        '<label class="col-2">Metode Transfer</label>' +
                        '<p class="col">' + detail.metodeTransfer + '</p>' +
                    '</div>' +
                    '<div class="row">' +
                        '<label class="col-2">Nilai Pajak</label>' +
                        '<p class="col">Rp ' + formatUang(detail.nilaiPajak) + '</p>' +
                    '</div>' +
                    '<div class="row">' +
                        '<label class="col-2">Nilai Transfer</label>' +
                        '<p class="col">Rp ' + formatUang(detail.nilaiTransfer) + '</p>' +
                    '</div>' +
                    '<div class="row">' +
                        '<label class="col-2">Tanggal Transfer</label>' +
                        '<p class="col">' + detail.tanggal.transfer + '</p>' +
                    '</div>' +
                '</div >'

            $('#modalDetailTiket').html(templatePengajuan)

            //tombol periksa pada modal
            if (!document.getElementById("periksaTiketVerifikator") && detail.posisi == "Verifikator" && detail.status == 'Belum selesai'){
                $(".modal-footer").append(
                    '<form action="/loket/verifikator" method="post">' +
                        '<input type="hidden" name="tiketId" value="' + detail._id + '" />' +
                        '<button type="submit" class="btn btn-primary" id="periksaTiketVerifikator">Periksa Tiket Verifikator</button>' +
                    '</form>')
            } else if (!document.getElementById("periksaTiketPpk") && detail.posisi == "PPK" && detail.status == 'Belum selesai'){
                $(".modal-footer").append(
                    '<form action="/loket/ppk" method="post">' +
                        '<input type="hidden" name="tiketId" value="' + detail._id + '" />' +
                        '<button type="submit" class="btn btn-primary" id="periksaTiketPpk">Periksa Tiket PPK</button>' +
                    '</form>')
            } else if (!document.getElementById("periksaTiketPpspm") && detail.posisi == "PPSPM" && detail.status == 'Belum selesai'){
                $(".modal-footer").append(
                    '<form action="/loket/ppspm" method="post">' +
                        '<input type="hidden" name="tiketId" value="' + detail._id + '" />' +
                        '<button type="submit" class="btn btn-primary" id="periksaTiketPpspm")">Periksa Tiket PPSPM</button>' +
                    '</form>')
            } else if (!document.getElementById("periksaTiketReviewer") && detail.posisi == "Reviewer" && detail.status == 'Belum selesai'){
                $(".modal-footer").append(
                    '<form action="/loket/reviewer" method="post">' +
                        '<input type="hidden" name="tiketId" value="' + detail._id + '" />' +
                        '<button type="submit" class="btn btn-primary" id="periksaTiketReviewer">Periksa Tiket Reviewer</button>' +
                    '</form>')
            } else if (!document.getElementById("periksaTiketBendahara") && detail.posisi == "Bendahara" && detail.status == 'Belum selesai'){
                $(".modal-footer").append(
                    '<form action="/loket/bendahara" method="post">' +
                        '<input type="hidden" name="tiketId" value="' + detail._id + '" />' +
                        '<button type="submit" class="btn btn-primary" id="periksaTiketBendahara">Periksa Tiket Bendahara</button>' +
                    '</form>')
            } else if (!document.getElementById("periksaTiketBank") && detail.posisi == "Operator Bank" && detail.status == 'Belum selesai'){
                $(".modal-footer").append(
                    '<form action="/loket/bank" method="post">' +
                        '<input type="hidden" name="tiketId" value="' + detail._id + '" />' +
                        '<button type="submit" class="btn btn-primary" id="periksaTiketBank">Periksa Tiket Operator Bank</button>' +
                    '</form>')
            }

        })

        //format uang
        $('td.format-uang').autoNumeric('init', {digitGroupSeparator: ',', decimalCharacter: '.', decimalPlacesOverride: '0'});
        //format uang2 bisa pake ini
        //$('td.format-uang').each(function() {
        //    $(this).text(formatUang($(this).text()));
        //});
        //format uang dari net--------
        //let cells = Array.prototype.slice.call(document.querySelectorAll(".format-uang"));
        //console.log(cells)
        //cells.forEach(function(cell){
        //    cell.textContent = (+cell.textContent).toLocaleString('in-ID', { style: 'currency', currency: 'IDR' });
        //});
    });

    //socket.on('forbiddenuser', function(user){
    //    generalAlert('Maaf Anda bukan '+ user +'. Silahkan ganti akun Anda')
    //})

    //fungsi
    function formatTanggal(tgl) {
        let s = Date.parse(tgl)
        let d = new Date(s)
        let tahun = d.getFullYear()
        let bulan = d.getMonth() + 1
        let hari = d.getDate()
        return `${hari}/${bulan}/${tahun}`
    }

    function formatUang(x) {
        if (x) {return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")
        } else return ''
    }

    function generalAlert(message){
        $.toast({
            text: message,
            textAlign: 'left', 
            hideAfter: 5000,
            loader: false,
            position: 'bottom-right',
            stack: 2
        })
    }

</script>